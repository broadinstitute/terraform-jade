{{ $project := "jade" }}
{{ with $environment := env "ENVIRONMENT" }}
{{with $suffix := env "SUFFIX"}}
{{$keyname := printf "secret/devops/terraform/%s/%s/override-%s" $environment $project $suffix}}
{{ with secret $keyname }}

{{ if eq $environment "dev" }}

variable "initials" {
  type = list(string)
  default = [
  "monster",
  "ms"
  ]
}

locals {
  initialrecords = {
    jade-global-monster = {
      type = "A"
      rrdatas = "${google_compute_global_address.jade-initials-ip["monster"].address}"
    },
    jade-monster = {
      type = "CNAME"
      rrdatas = "jade-global-monster.datarepo-{{$environment}}.broadinstitute.org."
    },
    jade-global-ms = {
      type = "A"
      rrdatas = "${google_compute_global_address.jade-initials-ip["ms"].address}"
    },
    jade-ms = {
      type = "CNAME"
      rrdatas = "jade-global-ms.datarepo-{{$environment}}.broadinstitute.org."
    }
  }
}

module "initials-dns-set" {
  # terraform-shared repo
  source     = "github.com/broadinstitute/terraform-shared.git//terraform-modules/external-dns?ref=external-dns-0.0.2-tf-0.12"

  target_project = var.env_project
  region = var.region
  target_credentials = file("${var.env}_svc.json")
  target_dns_zone_name = "datarepo-${var.env}"
  records = local.initialrecords
}

resource "google_compute_global_address" "jade-initials-ip" {
  for_each    = toset(var.initials)
  provider    = google
  name        = "jade-{{$environment}}-${each.key}"
  depends_on  = [module.enable-services]
}

resource "google_sql_database" "jade-datarepo-initials-db" {
    for_each    = toset(var.initials)
    name        = "datarepo-${each.key}"
    project     = var.project
    instance    = google_sql_database_instance.jade_100_postgres[0].name
    charset     = "UTF8"
    collation   = "en_US.UTF8"
    depends_on  = [google_sql_database_instance.jade_100_postgres]
}

resource "google_sql_database" "jade-stairway-initials-db" {
    for_each    = toset(var.initials)
    name        = "stairway-${each.key}"
    project     = var.project
    instance    = google_sql_database_instance.jade_100_postgres[0].name
    charset     = "UTF8"
    collation   = "en_US.UTF8"
    depends_on  = [google_sql_database_instance.jade_100_postgres]
}
{{ end }}
{{ end }}
{{ end }}
{{ end }}
